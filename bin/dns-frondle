#!/bin/sh -euf

. _imports

[ $# == 0 ] && usage "<git-repo> dns-server [dns-server ...]"

me=`basename $0`
repo=$1
shift 1
servers=$*

for i in ${servers}
do
    ssh_ping ${i}
done

init_tmp
stamp
stamp=${__}
ver="${stamp}__${me}"
clone="${tmp}/${ver}"
git_clone ${repo} ${clone}

for i in ${servers}
do
    frondle_env
    echo "syncing to ${i}..."
    ssh ${i} 'mkdir -p '${DNSHOME}'/snaps'
    scp -rp -q ${clone} ${i}:${SNAPS}
done

for i in ${servers}
do
    frondle_env
    echo "linking live to ${ver}"
    ssh ${i} 'rm -f '${DNSHOME}'/live && ln -s '${SNAPS}'/'${ver} ${DNSHOME}'/live'
done

for i in ${servers}
do
    ssh ${i} 'rndc reload'
done

# signal each
